<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudioMusik Jjenaissante - Booking Studio Musik Online</title>
    <meta name="description" content="Booking studio musik dengan mudah dan cepat. Tersedia berbagai studio dengan fasilitas lengkap.">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/confirmDate/confirmDate.min.css">
    <link rel="stylesheet" href="style.css">
    
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-dark: #3730a3;
            --secondary-color: #f59e0b;
            --accent-color: #10b981;
            --danger-color: #ef4444;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-900: #111827;
            --light-color: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --border-radius: 0.5rem;
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; line-height: 1.6; color: var(--gray-900); background-color: #f9fafb; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }

        /* Navigation */
        .navbar { position: fixed; top: 0; left: 0; right: 0; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--gray-200); z-index: 1000; transition: all 0.3s ease; }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .nav-logo { display: flex; align-items: center; text-decoration: none; color: var(--primary-color); font-weight: 700; font-size: 1.25rem; }
        .nav-logo i { margin-right: 0.5rem; font-size: 1.5rem; }
        .nav-menu { display: flex; list-style: none; align-items: center; }
        .nav-menu li { margin-left: 2rem; }
        .nav-link { text-decoration: none; color: var(--gray-600); font-weight: 500; transition: color 0.3s ease; position: relative; }
        .nav-link:hover, .nav-link.active { color: var(--primary-color); }
        .nav-link.active::after { content: ''; position: absolute; bottom: -0.5rem; left: 0; right: 0; height: 2px; background: var(--primary-color); border-radius: 1px; }
        .nav-toggle { display: none; flex-direction: column; cursor: pointer; }
        .nav-toggle span { width: 25px; height: 3px; background: var(--gray-600); margin: 3px 0; transition: 0.3s; }

        /* Hero Section */
        .hero { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: white; padding: 120px 0 80px; margin-top: 70px; position: relative; overflow: hidden; }
        .hero-content { text-align: center; position: relative; z-index: 1; }
        .hero-title { font-size: 3rem; font-weight: 700; margin-bottom: 1rem; line-height: 1.2; }
        .hero-subtitle { font-size: 1.25rem; margin-bottom: 2rem; opacity: 0.9; max-width: 600px; margin-left: auto; margin-right: auto; }
        .hero-buttons { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border: none; border-radius: var(--border-radius); font-weight: 600; text-decoration: none; cursor: pointer; transition: all 0.3s ease; font-size: 1rem; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background: transparent; color: white; border: 2px solid rgba(255, 255, 255, 0.3); }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.1); border-color: rgba(255, 255, 255, 0.5); }
        .btn-lg { padding: 1rem 2rem; font-size: 1.1rem; }

        /* Sections & Cards */
        .section { padding: 5rem 0; }
        .section-header { text-align: center; margin-bottom: 3rem; }
        .section-title { font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem; color: var(--gray-900); }
        .section-subtitle { font-size: 1.1rem; color: var(--gray-600); max-width: 600px; margin: 0 auto; }
        .grid { display: grid; gap: 2rem; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .card { background: white; border-radius: 1rem; box-shadow: var(--shadow-md); overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .card-body { padding: 2rem; }
        .card-title { font-size: 1.25rem; font-weight: 600; color: var(--gray-900); margin-bottom: 0.5rem; }
        .card-text { color: var(--gray-600); }

        /* Forms */
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700); }
        .form-control { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--border-radius); font-size: 1rem; transition: all 0.3s ease; background: white; }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .booking-form { background: white; border-radius: 1rem; box-shadow: var(--shadow-lg); overflow: hidden; max-width: 800px; margin: 0 auto; }
        .form-header { background: var(--primary-color); color: white; padding: 2rem; text-align: center; }
        .form-body { padding: 2rem; }
        .booking-summary { background: var(--gray-100); border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 2rem; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-200); }
        
/* Studio Card Specifics */
        .studio-card {
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            overflow: hidden; /* Penting: menahan gambar agar tidak keluar */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .studio-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .studio-image {
            width: 100%;
            height: 220px; /* Tinggi gambar */
            position: relative;
            overflow: hidden;
            background-color: var(--gray-200);
        }

        .studio-image img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Agar gambar full tanpa gepeng */
            transition: transform 0.5s ease;
        }

        /* Efek Zoom saat mouse diarahkan */
        .studio-card:hover .studio-image img {
            transform: scale(1.1);
        }

        .studio-info {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* Kode di bawah ini (room-item, room-price) biarkan saja seperti aslinya */
        .room-item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 0.75rem; 
            background: var(--gray-100); 
            border-radius: var(--border-radius); 
            margin-bottom: 0.5rem; 
        }
        .room-price { 
            font-weight: 600; 
            color: var(--primary-color); 
        }

        /* Footer */
        .footer { background: var(--gray-900); color: white; padding: 3rem 0 1rem; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem; }
        .footer-section h3 { margin-bottom: 1rem; color: var(--primary-color); }
        .footer-section a { color: #9ca3af; text-decoration: none; display: block; margin-bottom: 0.5rem; }
        .footer-bottom { text-align: center; padding-top: 2rem; border-top: 1px solid #374151; color: #6b7280; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 1rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid var(--gray-200); }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 1.5rem; }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-menu { position: fixed; top: 70px; left: -100%; width: 100%; height: calc(100vh - 70px); background: white; flex-direction: column; justify-content: flex-start; align-items: center; transition: 0.3s; box-shadow: var(--shadow-lg); padding-top: 2rem; }
            .nav-menu.active { left: 0; }
            .nav-menu li { margin: 1rem 0; }
            .nav-toggle { display: flex; }
            .hero-title { font-size: 2rem; }
            .grid-3 { grid-template-columns: 1fr; }
        }
        
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <a href="#" class="nav-logo">
                <i class="fas fa-music"></i>
                <span>StudioMusik Jjenaissante</span>
            </a>
            
            <ul class="nav-menu" id="nav-menu">
                <li><a href="#home" class="nav-link active">Beranda</a></li>
                <li><a href="#studios" class="nav-link">Studio</a></li>
                <li><a href="#booking" class="nav-link">Booking</a></li>
                <li><a href="calendar.html" class="nav-link">Kalender</a></li>
                <li><a href="history.html" class="nav-link">Riwayat</a></li>
                <li><a href="#about" class="nav-link">Tentang</a></li>
                <li id="auth-section">
                    <a href="login.html" class="nav-link" id="login-btn" style="background: var(--primary-color); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; margin-left: 1rem;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </a>
                </li>
            </ul>
            
            <div class="nav-toggle" id="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <section class="hero" id="home">
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title">Booking Studio Musik Jadi Lebih Mudah</h1>
                <p class="hero-subtitle">Pilih studio favoritmu, tentukan waktu, dan nikmati pengalaman bermusik terbaik dengan fasilitas profesional.</p>
                <div class="hero-buttons">
                    <a href="#booking" class="btn btn-primary">
                        <i class="fas fa-calendar-check"></i>
                        Booking Sekarang
                    </a>
                    <a href="#studios" class="btn btn-secondary">
                        <i class="fas fa-building"></i>
                        Lihat Studio
                    </a>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="studios">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Studio Kami</h2>
                <p class="section-subtitle">Pilih dari berbagai studio dengan fasilitas lengkap dan kualitas suara terbaik</p>
            </div>
            <div class="grid grid-3" id="studios-grid"></div>
        </div>
    </section>

    <section class="section" style="background: var(--gray-100);" id="booking">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Booking Cepat</h2>
                <p class="section-subtitle">Isi form di bawah ini untuk melakukan booking studio</p>
            </div>
            
            <div class="booking-form">
                <div class="form-header">
                    <h3><i class="fas fa-calendar-alt"></i> Form Booking Studio</h3>
                    <p>Lengkapi data di bawah ini untuk melakukan booking</p>
                </div>
                
                <div class="form-body">
                    <form id="booking-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="nama">Nama Lengkap *</label>
                                <input type="text" class="form-control" id="nama" name="nama" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="no_hp">Nomor HP *</label>
                                <input type="tel" class="form-control" id="no_hp" name="no_hp" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="email">Email</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="studio">Pilih Studio *</label>
                                <select class="form-control" id="studio" name="studio" required>
                                    <option value="">-- Pilih Studio --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="ruangan">Pilih Ruangan *</label>
                                <select class="form-control" id="ruangan" name="ruangan" required>
                                    <option value="">-- Pilih Ruangan --</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="tanggal">Tanggal Booking *</label>
                                <input type="date" class="form-control" id="tanggal" name="tanggal" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="jam_mulai">Jam Mulai *</label>
                                <input type="text" class="form-control" id="jam_mulai" name="jam_mulai" placeholder="Pilih Jam (Scroll)" required style="background-color: #fff;">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="durasi">Durasi (Jam) *</label>
                                <select class="form-control" id="durasi" name="durasi" required>
                                    <option value="">-- Pilih Durasi --</option>
                                    <option value="1">1 Jam</option>
                                    <option value="2">2 Jam</option>
                                    <option value="3">3 Jam</option>
                                    <option value="4">4 Jam</option>
                                    <option value="5">5 Jam</option>
                                    <option value="6">6 Jam</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="catatan">Catatan Tambahan</label>
                            <textarea class="form-control" id="catatan" name="catatan" rows="3" placeholder="Masukkan catatan tambahan (opsional)"></textarea>
                        </div>
                        
                        <div class="booking-summary" id="booking-summary" style="display: none;">
                            <h4><i class="fas fa-receipt"></i> Ringkasan Booking</h4>
                            <div class="summary-row">
                                <span>Studio & Ruangan:</span>
                                <span id="summary-studio">-</span>
                            </div>
                            <div class="summary-row">
                                <span>Tanggal:</span>
                                <span id="summary-tanggal">-</span>
                            </div>
                            <div class="summary-row">
                                <span>Jam:</span>
                                <span id="summary-jam">-</span>
                            </div>
                            <div class="summary-row">
                                <span>Durasi:</span>
                                <span id="summary-durasi">-</span>
                            </div>
                            <div class="summary-row">
                                <span>Tarif per Jam:</span>
                                <span id="summary-tarif">-</span>
                            </div>
                            <div class="summary-row">
                                <span>Total Bayar:</span>
                                <span id="summary-total">-</span>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg" style="width: 100%; margin-top: 1rem;">
                            <i class="fas fa-paper-plane"></i>
                            Booking Sekarang!
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <section class="section" id="about">
        <div class="container">
            <div class="section-header">
                <h2 class="section-title">Tentang Kami</h2>
                <p class="section-subtitle">Studio musik profesional dengan fasilitas terbaik</p>
            </div>
            <div class="grid grid-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-microphone-alt" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                        <h3 class="card-title">Recording Studio</h3>
                        <p class="card-text">Studio rekaman profesional dengan peralatan audio berkualitas tinggi.</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-guitar" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                        <h3 class="card-title">Practice Room</h3>
                        <p class="card-text">Ruang latihan nyaman dengan instrumen lengkap.</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-headphones" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                        <h3 class="card-title">Mixing & Mastering</h3>
                        <p class="card-text">Layanan mixing dan mastering profesional.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>StudioMusik Jjenaissante</h3>
                    <p>Platform booking studio musik online profesional.</p>
                    <p><i class="fas fa-phone"></i> +62 831-8258-6472</p>
                </div>
                <div class="footer-section">
                    <h3>Informasi</h3>
                    <a href="#about">Tentang Kami</a>
                    <a href="calendar.html">Kalender Booking</a>
                </div>
                <div class="footer-section">
                    <h3>Lokasi</h3>
                    <p>Jl. Aji Stone no 32, Batam Selatan</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2026 StudioMusik Jjenaissante. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Informasi</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // Global variables
        let studiosData = [];
        let currentUser = null;
        let timePicker;

        document.addEventListener('DOMContentLoaded', function() {
            // Load urutan: Cek Auth, Load Studio, Setup Listener
            checkAuthStatus();
            loadStudios();
            initializeBookingForm();
            setupEventListeners();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal').min = today;
        });

        // ==========================================
        // FIXED AUTHENTICATION LOGIC (Client-Side)
        // ==========================================
        // Check authentication status
        async function checkAuthStatus() {
            // 1. CEK LOCALSTORAGE DULU (Agar UI langsung berubah cepat)
            const localData = localStorage.getItem('user');
            if (localData) {
                currentUser = JSON.parse(localData);
                updateAuthSection(); // Ubah tombol Login jadi Nama User
                
                // Isi form otomatis jika ada
                const namaField = document.getElementById('nama');
                const emailField = document.getElementById('email');
                if (namaField) namaField.value = currentUser.nama_user || currentUser.name;
                if (emailField) emailField.value = currentUser.email;
            }

            // 2. VERIFIKASI KE SERVER (Di background)
            try {
                // Tambah timestamp agar browser tidak cache hasil lama
                const response = await fetch('api.php?endpoint=me&t=' + new Date().getTime());
                const result = await response.json();
                
                if (result.success && result.user) {
                    // Update data terbaru dari server
                    currentUser = result.user;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    updateAuthSection();
                } else {
                    // Jika server bilang tidak login, tapi localStorage ada isinya, hapus localStorage
                    // HANYA JIKA localStorage ada isinya (mencegah loop)
                    if (localStorage.getItem('user')) {
                        console.log('Session expired on server');
                        localStorage.removeItem('user');
                        currentUser = null;
                        updateAuthSection();
                    }
                }
            } catch (error) {
                console.error('Auth Check Error:', error);
            }
        }

        function updateAuthSection() {
            const authSection = document.getElementById('auth-section');
            if (!authSection) return;

            if (currentUser) {
                authSection.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <a href="profile.html" class="nav-link" style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user-circle"></i>
                            <span>${currentUser.nama_user || currentUser.name}</span>
                        </a>
                        <a href="#" onclick="handleLogout()" class="nav-link" style="color: var(--danger-color);">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    </div>
                `;
            } else {
                authSection.innerHTML = `
                    <a href="login.html" class="nav-link" id="login-btn" style="background: var(--primary-color); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; margin-left: 1rem;">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </a>
                `;
            }
        }

        async function handleLogout() {
            if(confirm("Yakin ingin keluar?")) {
                try {
                    await fetch('auth.php?action=logout');
                } catch (e) { console.error(e); }
                
                localStorage.removeItem('user');
                currentUser = null;
                window.location.reload();
            }
        }

        // ==========================================
        // STUDIO & BOOKING LOGIC
        // ==========================================
        function setupEventListeners() {
            const navToggle = document.getElementById('nav-toggle');
            const navMenu = document.getElementById('nav-menu');
            
            navToggle.addEventListener('click', () => navMenu.classList.toggle('active'));
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('modal')) closeModal();
            });

            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        navMenu.classList.remove('active');
                    }
                });
            });
        }

        async function loadStudios() {
            try {
                const response = await fetch('api.php?endpoint=studios');
                const result = await response.json();
                if (result.success) {
                    studiosData = result.data;
                    displayStudios();
                    populateStudioSelect();
                }
            } catch (error) {
                console.error('Error loading studios:', error);
            }
        }

function displayStudios() {
            const grid = document.getElementById('studios-grid');
            grid.innerHTML = '';
            
            const studioImages = [
                'img/studio1.png', 
                'img/studio2.png', 
                'img/studio3.png'
            ];

            studiosData.forEach((studio, index) => {
                let roomsHtml = '';
                studio.ruangan.forEach(room => {
                    roomsHtml += `
                        <div class="room-item">
                            <div>
                                <div class="room-name" style="font-weight:600;">${room.nama_ruangan}</div>
                                <div class="room-capacity" style="font-size: 0.85rem; color: #666;">
                                    Kap: ${room.kapasitas} org
                                </div>
                            </div>
                            <div class="room-price">Rp ${parseInt(room.tarif_per_jam).toLocaleString('id-ID')}</div>
                        </div>`;
                });

                // Pilih gambar secara berurutan
                // Jika studio ke-1 pakai gambar 1, studio ke-4 akan balik pakai gambar 1 lagi (looping)
                const imageSrc = studioImages[index % studioImages.length];

                const card = document.createElement('div');
                card.className = 'card studio-card';
                
                // Disini kita menyusun HTML untuk kartu barunya
                card.innerHTML = `
                    <div class="studio-image">
                        <img src="${imageSrc}" alt="${studio.nama_studio}" onerror="this.src='https://via.placeholder.com/400x220?text=No+Image'">
                        <div style="position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 20px 15px 10px;">
                            <span style="background: var(--primary-color); color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                <i class="far fa-clock"></i> ${studio.jam_buka} - ${studio.jam_tutup}
                            </span>
                        </div>
                    </div>
                    <div class="studio-info">
                        <h3 class="studio-name" style="margin-bottom: 5px;">${studio.nama_studio}</h3>
                        <p class="studio-address" style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem;">
                            <i class="fas fa-map-marker-alt" style="color: var(--danger-color);"></i> ${studio.alamat}
                        </p>
                        <div class="studio-rooms" style="margin-bottom: 1rem;">${roomsHtml}</div>
                        
                        <button onclick="pilihStudioUntukBooking('${studio.id_studio}')" 
                            class="btn btn-primary" style="width: 100%; margin-top: auto; justify-content: center;">
                            Booking Sekarang
                        </button>
                    </div>`;
                grid.appendChild(card);
            });
        }

        // Tambahkan fungsi kecil ini agar tombol "Booking Sekarang" berfungsi
        function pilihStudioUntukBooking(idStudio) {
            document.getElementById('studio').value = idStudio;
            handleStudioChange(); // Update dropdown ruangan otomatis
            window.location.href = '#booking'; // Scroll ke form booking
        }

        function populateStudioSelect() {
            const select = document.getElementById('studio');
            select.innerHTML = '<option value="">-- Pilih Studio --</option>';
            studiosData.forEach(studio => {
                const option = document.createElement('option');
                option.value = studio.id_studio;
                option.textContent = studio.nama_studio;
                select.appendChild(option);
            });
            select.addEventListener('change', handleStudioChange);
        }

        function handleStudioChange() {
            const studioId = document.getElementById('studio').value;
            const roomSelect = document.getElementById('ruangan');
            roomSelect.innerHTML = '<option value="">-- Pilih Ruangan --</option>';
            if(timePicker) timePicker.clear();
            
            if (studioId) {
                const studio = studiosData.find(s => s.id_studio === studioId);
                if (studio) {
                    studio.ruangan.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room.id_ruangan;
                        option.textContent = room.nama_ruangan;
                        roomSelect.appendChild(option);
                    });
                    if(timePicker) {
                        timePicker.set('minTime', studio.jam_buka);
                        timePicker.set('maxTime', studio.jam_tutup);
                    }
                }
            }
            updateBookingSummary();
        }

        function initializeBookingForm() {
            const jamMulaiInput = document.getElementById('jam_mulai');
            timePicker = flatpickr(jamMulaiInput, {
                enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true,
                minTime: "08:00", maxTime: "22:00", disableMobile: "true",
                onChange: updateBookingSummary
            });

            ['ruangan', 'tanggal', 'durasi'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateBookingSummary);
            });
            
            document.getElementById('ruangan').addEventListener('change', loadAvailableTimeSlots);
            document.getElementById('tanggal').addEventListener('change', loadAvailableTimeSlots);
            document.getElementById('booking-form').addEventListener('submit', handleBookingSubmit);
        }

        async function loadAvailableTimeSlots() {
            const roomId = document.getElementById('ruangan').value;
            const date = document.getElementById('tanggal').value;
            if (!roomId || !date) return;
            if(timePicker) timePicker.clear();

            try {
                const response = await fetch(`api.php?endpoint=available-slots&id_ruangan=${roomId}&date=${date}`);
                const result = await response.json();
                if (result.success && result.data && timePicker) {
                    const disabledTimes = result.data.filter(s => !s.available).map(s => ({ from: s.start, to: s.end }));
                    timePicker.set('disable', disabledTimes);
                }
            } catch (error) { console.error(error); }
        }

        function updateBookingSummary() {
            const roomId = document.getElementById('ruangan').value;
            const date = document.getElementById('tanggal').value;
            const time = document.getElementById('jam_mulai').value;
            const duration = document.getElementById('durasi').value;
            const summary = document.getElementById('booking-summary');
            
            if (roomId && date && time && duration) {
                const studioId = document.getElementById('studio').value;
                const studio = studiosData.find(s => s.id_studio === studioId);
                const room = studio?.ruangan.find(r => r.id_ruangan === roomId);
                if (room) {
                    const price = parseInt(room.tarif_per_jam);
                    const total = price * parseInt(duration);
                    document.getElementById('summary-studio').textContent = `${studio.nama_studio} - ${room.nama_ruangan}`;
                    document.getElementById('summary-tanggal').textContent = new Date(date).toLocaleDateString('id-ID');
                    document.getElementById('summary-jam').textContent = time;
                    document.getElementById('summary-durasi').textContent = duration + ' Jam';
                    document.getElementById('summary-tarif').textContent = 'Rp ' + price.toLocaleString('id-ID');
                    document.getElementById('summary-total').textContent = 'Rp ' + total.toLocaleString('id-ID');
                    summary.style.display = 'block';
                }
            } else { summary.style.display = 'none'; }
        }

        async function handleBookingSubmit(e) {
            e.preventDefault();
            if (!currentUser) {
                showModal('Login Diperlukan', '<p>Silakan login terlebih dahulu.</p><button class="btn btn-primary" onclick="window.location.href=\'login.html\'">Login</button>');
                return;
            }
            
            const formData = new FormData(e.target);
            const data = {
                id_user: currentUser.id_user,
                id_ruangan: formData.get('ruangan'),
                tanggal_booking: formData.get('tanggal'),
                jam_mulai: formData.get('jam_mulai'),
                durasi: parseInt(formData.get('durasi')),
                catatan: formData.get('catatan')
            };
            
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Memproses...';
            btn.disabled = true;

            try {
                const response = await fetch('api.php?endpoint=booking', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    showPaymentModal(result.data.id_booking, document.getElementById('summary-total').textContent);
                    e.target.reset();
                    document.getElementById('booking-summary').style.display='none';
                } else {
                    showModal('Gagal', `<p>${result.message}</p>`);
                }
            } catch (err) {
                showModal('Error', '<p>Terjadi kesalahan jaringan.</p>');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }
        function closeModal() { document.getElementById('modal').classList.remove('active'); }

        // --- PAYMENT FUNCTIONALITY ---
        function showPaymentModal(bookingId, totalAmount) {
            const html = `
                <div class="payment-modal-body">
                    <div class="payment-qris-container">
                        <img src="img/qris_dummy.svg" alt="QRIS Code">
                    </div>
                    <div class="payment-amount">${totalAmount}</div>

                    <div class="payment-instructions">
                        <strong>Cara Pembayaran:</strong>
                        <ol>
                            <li>Scan QRIS di atas menggunakan e-wallet (GoPay, OVO, Dana, dll) atau Mobile Banking.</li>
                            <li>Periksa nominal pembayaran.</li>
                            <li>Selesaikan pembayaran.</li>
                            <li>Screenshot bukti pembayaran dan upload di bawah ini.</li>
                        </ol>
                    </div>

                    <form id="payment-form" onsubmit="handlePaymentSubmit(event, '${bookingId}')">
                        <div class="upload-area" onclick="document.getElementById('proof_file').click()">
                            <i class="fas fa-cloud-upload-alt upload-icon"></i>
                            <div class="upload-text">Klik untuk upload bukti pembayaran</div>
                            <input type="file" id="proof_file" name="bukti_pembayaran" accept="image/*,application/pdf" style="display: none" onchange="previewFile(this)" required>
                            <div class="file-preview" id="file-preview">
                                <img id="preview-img" src="">
                                <p id="filename" style="margin-top:0.5rem; font-size:0.8rem;"></p>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%">
                            <i class="fas fa-check-circle"></i> Konfirmasi Pembayaran
                        </button>
                    </form>
                </div>
            `;
            showModal('Pembayaran', html);
        }

        function previewFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('file-preview');
                    const img = document.getElementById('preview-img');

                    if (input.files[0].type.startsWith('image/')) {
                        img.src = e.target.result;
                        img.style.display = 'block';
                    } else {
                        img.style.display = 'none';
                    }

                    document.getElementById('filename').textContent = input.files[0].name;
                    preview.style.display = 'block';
                    document.querySelector('.upload-text').style.display = 'none';
                    document.querySelector('.upload-icon').style.display = 'none';
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function handlePaymentSubmit(e, bookingId) {
            e.preventDefault();
            const form = e.target;
            const fileInput = document.getElementById('proof_file');

            if (!fileInput.files.length) {
                alert('Mohon upload bukti pembayaran');
                return;
            }

            const formData = new FormData();
            formData.append('id_booking', bookingId);
            formData.append('bukti_pembayaran', fileInput.files[0]);

            const btn = form.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Mengupload...';
            btn.disabled = true;

            try {
                const response = await fetch('api.php?endpoint=upload-proof', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    showModal('Sukses', `
                        <div class="text-center">
                            <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--accent-color); margin-bottom: 1rem;"></i>
                            <h3>Pembayaran Berhasil Dikirim!</h3>
                            <p>Admin akan segera memverifikasi pembayaran Anda.</p>
                            <button class="btn btn-primary" onclick="window.location.href='history.html'">Lihat Riwayat</button>
                        </div>
                    `);
                } else {
                    alert('Gagal: ' + result.message);
                }
            } catch (err) {
                alert('Terjadi kesalahan saat upload.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>